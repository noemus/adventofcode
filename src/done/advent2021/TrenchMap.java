package done.advent2021;

import util.LineSupplier;

import java.util.Objects;
import java.util.Scanner;
import java.util.stream.IntStream;
import java.util.stream.Stream;

import static java.util.stream.Collectors.joining;
import static util.Utils.Repeat.repeat;

public class TrenchMap {

    static String algorithm;
    static ImageLine[] image;
    static int round = 0;

    public static void main(String[] args) {
        try (Scanner in = new Scanner(INPUT)) {
            algorithm = in.nextLine();
            in.nextLine();

            image = Stream.generate(new LineSupplier(in))
                    .takeWhile(Objects::nonNull)
                    .map(ImageLine::from)
                    .toArray(ImageLine[]::new);

            printImage();

            repeat(50).action(TrenchMap::enhance);

            printImage();

            long result = Stream.of(image)
                                .mapToLong(ImageLine::countLight)
                                .sum();

            System.out.println("Result: " + result);
        }
    }

    private static void enhance() {
        ImageLine.update();

        ImageLine[] newImage = new ImageLine[image.length + 2];
        newImage[0] = upperLine().enhance();
        newImage[image.length + 1] = lowerLine().enhance();
        IntStream.range(0, image.length).forEach(row ->
                newImage[row + 1] = image[row].enhance());
        image = newImage;
        round++;
    }

    private static void printImage() {
        Stream.of(image).map(ImageLine::line).forEach(System.out::println);
        System.out.println();
    }

    static ImageLine upperLine() {
        return new ImageLine(-1, "");
    }

    static ImageLine lowerLine() {
        return new ImageLine(ImageLine.lastRow + 1, "");
    }

    record ImageLine(int row, String line) {
        static final char ONE = '1';
        static final char ZERO = '0';
        static final char LIGHT = '#';
        static final char DARK = '.';

        static final String TRIPLE_ZERO = "000";
        static final String TRIPLE_ONE = "111";

        static String blankTriple() {
            if (algorithm.charAt(0) == DARK) {
                return TRIPLE_ZERO;
            }
            return (round % 2) == 0 ? TRIPLE_ZERO : TRIPLE_ONE;
        }

        static char blankPixel() {
            if (algorithm.charAt(0) == DARK) {
                return ZERO;
            }
            return (round % 2) == 0 ? ZERO : ONE;
        }

        static int lastRow = -1;
        static int lastIdx = -1;

        long countLight() {
            return line.chars()
                       .filter(c -> c == LIGHT)
                       .count();
        }

        ImageLine enhance() {
            char first = enhance(-1);
            char last = enhance(lastIdx + 1);
            String newLine = IntStream.rangeClosed(0, lastIdx)
                                      .map(this::enhance)
                                      .mapToObj(Character::toString)
                                      .collect(joining());

            return new ImageLine(row + 1, first + newLine + last);
        }

        char enhance(int idx) {
            int pixelIndex = Integer.valueOf(neigbours(idx), 2);
            return algorithm.charAt(pixelIndex);
        }

        String neigbours(int idx) {
            return upperNeigbours(idx) + lineNeigbours(idx) + lowerNeigbours(idx);
        }

        private String lineNeigbours(int idx) {
            if (row < 0 || row > lastRow) {
                return blankTriple();
            }
            return "" + pixel(idx - 1) + pixel(idx) + pixel(idx + 1);
        }

        private String upperNeigbours(int idx) {
            if (row <= 0) {
                return blankTriple();
            }
            return image[row - 1].lineNeigbours(idx);
        }

        private String lowerNeigbours(int idx) {
            if (row >= lastRow) {
                return blankTriple();
            }
            return image[row + 1].lineNeigbours(idx);
        }

        private char pixel(int idx) {
            if (idx < 0 || idx > lastIdx) {
                return blankPixel();
            }
            return line.charAt(idx) == LIGHT ? ONE : ZERO;
        }

        static ImageLine from(String line) {
            if (lastIdx == -1) {
                lastIdx = line.length() - 1;
            }
            return new ImageLine(++lastRow, line);
        }

        static void update() {
            lastRow = image.length - 1;
            lastIdx = image[0].line.length() - 1;
        }
    }

    @SuppressWarnings("unused")
    private static final String INPUT1 = """
            ..#.#..#####.#.#.#.###.##.....###.##.#..###.####..#####..#....#..#..##..###..######.###...####..#..#####..##..#.#####...##.#.#..#.##..#.#......#.###.######.###.####...#.##.##..#..#..#####.....#.#....###..#.##......#.....#..#..#..##..#...##.######.####.####.#.#...#.......#..#.#.#...####.##.#......#..#...##.#.##..#...##.#.##..###.#......#.#.......#.#.#.####.###.##...#.....####.#..#..#.##.#....##..#.####....##...##..#...#......#.#.......#.......##..####..#...#.#.#...##..#.#..###..#####........#..####......#..#
                        
            #..#.
            #....
            ##..#
            ..#..
            ..###""";

    @SuppressWarnings("unused")
    private static final String INPUT = """
            #..##..#.#.#.###.#..##.####..##..##.##.#.###.......##..#..#.#.#.#..#...##....#.#.##.###....###.#.##.##..##.#...##.##...#...##......##.#...#.......##.#.#..####.##..#.#.#.....##.....#....#.#.#.##..##..##.##.....###...#.#..###.#######.#.....###....#......#.###.#...#.#####.#.#.###..#...##.##.#..#...######.###.#.##...####..####.###...####........##...##.##.####...##.#.#...##.#####.#....#.....##..#......###..###.#.#..###..#.####......#.....#.#.#.###..#.#..#..#...##..##..#.##....#....#.##..###..#....##.##..#.###..
                        
            .##.##...###.####.#.##..#.#.#.#.##.#.###....#.###....#..##.#####.#.#..##..##.##.#.#.########...###..
            #.##..#..#.###...#..####.##.####.#..#...#..##...####...#..#.#.##...#.#.#.#..#...#.####..#..#..#....#
            ##...##.#.....#...##.###.#..#.#...#....##.##.###....#..##.#...###.###..#..#.#.#######..#...###...###
            .##.###....#..#.#...#.###..##.##.####.###.#....##.####.#.#..###..##....#.#####.#.#.#....##...#.##..#
            .##.#.#..##..#..#...#.#..#..##.#.########..####.##...#..#..##..#..##..##.......##.##..#..##..#..#.#.
            #.#.###...###.##.##.#.#...#####.#.#......#.###..#..#.##..#.#.##.###...###..##.#..##.###..###.####.##
            #.####.######....#####.......##....#.#...#..#.#..#.#.#####.#...###.#..###.......#.###.#.##.#.#...#..
            ....##.##.###.####..#.###.###.....####.##....#..###.###..#####...##.##.#.#..#..#..#.#.########.#.#..
            ##..#..#..#..####..#..#.#..###.#.####..###.##.###.##.###.###.#.##.##.#...#..#.###.###......#.####..#
            .####.#..######.#.#...#..###.#..#.##...#####.#####.#####.#.....###.#.##.......#....####..#..#.#.#...
            ......#....#.#..##.####.....#.##..###....###..##...###.#....#####.#..###..#.#....#..###..#.#...#####
            #.#.#########.##.#..##.#.#.##.#.##...###.#.....####...#..#..#####...#..#..#...##.#####.#.#....#..#.#
            #..####.#.#......###.#....#.#.#####.#..#..#.####..#.#...#.#.#.###..###.###..###..##.#.#.#.##....#.##
            #..#.#...###....##.#.##....##..#.#.#....#.##..########.###....###.#.##.#.####.###..#.#...#####.#.##.
            .####.###.#####..#.###..#.#..######.#.###.....#..####..#.#..###.##.##.####.......#..#.#.####..##.#..
            ##.##.#.......#.....####.#.##.###..###......#.##..#.#.#..##.###.#.###.###...#.##.####.######..##.###
            ##..#......#..#..#.#.###..##..##...#...###....#...#..#.###...#.##.###..###....##..##..###.###.#...##
            ..#...#.###....#....#.#######..#.#..#..#.####...#.###.#.#..#....#.#.##.#.###.#...####.#.#....#..#.#.
            ..##........#.....#.###..#.####.#..####.#..#.....#####.##..#.#.#..##......#.#..##...#...##.##...#.##
            ##.#..##....##...##.#####.##........#.#..#..#..###.####....#...####...#..###.#####.##....###.#.####.
            .#..#.#.#####..#.#.##.#.#.####.#..#...#..#....#....#..###########...##..####..##...#.##..#.#.##.....
            ..#..#.#.#.#........#...##.#..#..##.#.##.####...###....###.......#....##....#.###.##...###..#.###.#.
            ..#..#.##.###.###.##...#.####.###.###.##.#.####.##.#.##.###..#.##.##..#.###...#.##.#.##.#####...#...
            ...##..###.#####..#.#.###...##.....#.##..##..##.##.##..#...#..#####.#.####.#....####...#.###.##..###
            ###.####..##.#..#####.....###.####..##.#....#.#.#...#.#...###..###.#...#....##..##.#.#...#.##.####..
            ..#.#######..#.##.#...####...###..###.###..#..#######.###.##.##..#..#.#.####.##.##...######..#..##.#
            ###..#.###...####.#..#.##.#....#...#.#.#..#.####..#..#.##.#####..#.#......###..#..#..##.#.....##.#.#
            .#.#####.##.#.#..#..###.###.##.#.##..#.......#####.###..#.#.###.#####.....####.#....######.#.#.###.#
            #####...#..#....##......#.#..##..##.##.......#.........#.#......#....#.#.##...#..###.##.######.###..
            #...#..#.####.##....#.#....##.#.#...#..#.#.#.#..####.#......#####....##.##.####....##....#####...#.#
            .#.###....#.##.#...##.#.#.....#.#..#.#..##.#...#.....#.##.....###...##.#.#....##...#..##.#..##.#.#..
            ..#####.....#...##.#.....#.###.#..#....##.#..###.####...#.#.....###.##.#.#..####...#.###.#.#....#.##
            #..####.#...###...##.##.#.#..#..###.#..#.#.#.##..#...#.##.##..#.###.#..#.#######..#.######..#.###...
            ...#..#.#.###.##.##.###.###.#...###.#.#.#..##.##.##.###....#.##.#.#.#.#.#.####.#####...#.#.##.##..#.
            ..##.#.###.#####..##.#..####..#..##..#.#..#.#..###.#.##.##..#.#..###..#..###...##...###...#####.####
            ###.#...##.#.###.##...#.####....#####.###..###.#...#.####..#.#.#.#.#..#.###.###......###...#..#.####
            .###.....##..###.#.#####.#..##.#.##.#.#.#.....#.####..###.###....#.##..#...##...###......#....##..#.
            ..###.#.#####..##..#.###...#.##...##.#...####...#..#####..#..#.##.#.#....##.##..#..##...#.#..##.#..#
            .###...........#..###.#.#....#.##.#.##..##.#...#.##.#......#.#.###..##..#.####.###........#.##.#...#
            ##.....#.#####.##.##..#.#.######..##...######..#...####.###..#.##.#.###..##.#########.....#.#.....##
            ###....#..###..##..###.....#.#......##.#.##.#.#..##.###.#..#####...#.#######..........####...#....#.
            .###....#.#.#.#..##.#.#.#.##...#..#.###..#.......#.####...###.#.#.#....#.##########....######.#####.
            ..##...######..###..#...#..#..#####..###...#..######.#####.###.##.#.#..##....#.#...###..#......##.#.
            ##..##.#...#.#.#..###..##.##.#.##..###.###.#.......###..##.#######.##.##.#.####..#.#.#####.#...#.#..
            #.#..##..##.##...#...#.######.#.#.#.#.....##...#.##.##.#..###...#...##....#....#.#..#.#.##...#.###..
            ....#.#.....#.###...#.#...##....##..#.#.#....##.###....#....#..#...#.#.#####.###.##.####.####.#.#...
            .##...####.##.#....#.##..#....#...#.##...#.#......###.##.####..#.#######....#.#####..##.#.....##.#.#
            ....#.#....#...####..##..#.#.##......###.#...##..##..###..#.####..############....#...#..#......####
            ....#######..##.#.#...#..#.#..####....##..#.##.#.#...###...##..####...#..#.##.#.#####..###.####...#.
            ......###.#..#..###.##.#.#.#.#.#.##...##.##...##.#.#....##.#..#........#..###.#####....#####.#.####.
            ##...#########...##....#.#....#..#.#......#.##.#.###..#.##...#..######.#....#.###.#..#########.##...
            #..#..#.##..#####..#.###.#.##..##.##..#.......##.#...###..##.#.###..###..##..##..#.#.###.##....#####
            #.#.##..#.####.#.#.#..#......#.###.###..##...#.#.#.#...#.#..###.##...###.#...##.##.#.##...##.####.##
            #..##.###...##.#....#.#####.####.###.###.#..##..#....##..#..###.......####..##..#..###.#.#.#.#...#..
            #..#####...#.###..####.###.#..#...#..#...#..#.#...##.#..#..###.#....#.#......#..###..###.#.##.####..
            ##.##.#.####.#..##..#.###...###...#.....##....##...#.#..#..##.##.#...#..#.###.##..##..##.#.#.####.#.
            .#.#.######.##...###.####.#...###.##.##.#.#.#..##.##.###.#..#.###..####.######.##..###.#....##.#..##
            ##.##.###.#...#####.#.#.....#.#.#...#.##.###.##...#.###...###......###...##...##.##.#....#......##..
            ...##.#.#..#..#.#..###......#...###.#.####.##...##...##.##.##.##....#.##...#.##.##.##......###..#...
            #.#.....#.#..###...#.##..#..#.###..#######....#.###.#...#.##.#......##...#.###.##.#...#..#...#.#.#..
            .##.##........##.#.#...#####.##....#.#...###.#.##....##.##...##..#..#.#..####.#..##..#...##.##..##.#
            #.##.#.##.#.####....###.#..#..#.###....######.#.....####.#.#####..###..##.#.##.......###...##.#.###.
            .#..###..#..#.####...#..#..##.####.#..#.###.##.#.....###......####....##...###.#...####...#.#####.##
            ....#.#...#.##.....#...#...#.###...#...###...##.##.###.##.#.####..#.##.#....####..#####..#.#..#..#.#
            .###..##.#....##.###..#...##.##..###.###.#.##.##.####.####.######..#.#.#.###.##...####.#...##.#.#.#.
            ##..##.#......#.#.#...#..#.##.#.#.##.#..#.#..#.###.#..#...#..#...#...#.#..#....#.##..#######......#.
            .......##..#..#.###.#..###..###.#####.###.##...##.###.#..###.##....#.....#..#.#.###.###.#.####..#...
            #.#....###.##..##..#.#...##.#.#####.....#.#####.#.####.#.#....####..#..#.##.##....###...##.#.#.###.#
            .....#..##.#..##.#####.#.###.#.##.#..##.##...##..##..#.#...##.#.####.####..#..##.##.#.#..##..##.....
            .####.#.#.##..#....##..##.#...#....##.#.##.#.#.#.#...######.#..#.###.#.#.##....#...#..#.#.####..#..#
            ..###.###..#.##.#...###..##.##...##..##.###...####.###..#..#..#..###..##.#...#...#..##.#.#..........
            .....#.#..##.#.#..####..#..####.#....#..#..#.##.#..##..#...####.#####.##.#...##.####.#...#.#.##.##..
            ###....##....#.###....###.#.###..###..##..#..#...#####.##.#..#..####.#.#..###..#.#...###.##....##.##
            ###...###.##...##.#####.#..##.#....##.###.#######..##.####.#..#..###.###..#.#..#.##.#..##.#######.#.
            .####..#.#.###.#######.#.#...#.##.#...###.#.#..##.#.#....#.####..##...###..######.###..#####.##.###.
            .#...##.#.####...##.#...#.#...##.....#.#..#..##..#.#.####..#.##.##...##.#####.#...#..##.#.#.##.#.#.#
            .....##..##.####..##.#######..#..###.##.##..####.##..#.##...##..#..#....#...##.##.#..#...##.......#.
            #..#######..#####..###.##..###....######..#..#.#.....#....##..#.#..#.#..#.##.####.##.#.###.#####.###
            .##...#.##..###.#...##.#.#.###...#.#....##.####...#.###.###.###.##.###.##.###.#.####.....##..#.....#
            ##.##.#..#.......#..##....##..#####........#.###..##.#..##..#####.##.....###.#...#######.#...#.###.#
            .####..#.#####......#..###.##.##.##.###.#.#.......##.#####...#.#.####..#.#..###...#.....#.####.###.#
            ##..#.##.#....##.#######.#.#.#.####...#.#.#.#.#.......######.#..###..###.#..##..#.##.#......#.##..##
            .#.#.#.#...##.....##.#.#.........#.#.#.##.#.#...#.#.#.#.##....#..###.....###..###........###..#.##..
            .##.......#.#.####.....#....#.#....##.........#.......###.#..###..####...#...#.##.......###...#..###
            ###...#####.#.###.......#.##.#####.###..###..##..##.#..####..####..###..###.#..#.###.##.#.###...#.#.
            ##.#.#.##.##..#....#..##.#.#.#..#...#.##.###..##.###.#..##.......##...#.###.#.###.###....#...#.####.
            .###..##.........##.#.....###.##..#.#...#.#....###.####.###..###...#.#.##..#.#..#..#...#...#.....###
            ##.##.#...#..#..#....#........###.##.####.#.#..####..#..##.#...#...###...##.###.##.##.#########..#..
            .##.###.#.........####..####....##...###..##.##..#.#######.##.##...#..#....#.##..#..#..###.###.#.###
            #....#...##....###.####.#####.#.....##.#.##.#..#.....#...#.###...##.###.#.###..#.......####.##...#..
            .....#..#.##....##.#..##.#.#.#.##.#.#.####..#.##..##.#.#.#.#.#.#.######..#....##.##...#..#...##..#..
            ....#.#.##...#.##..#...#.##...#.#.###.#####.#.##..###...##.##.#.#..##.##.#...#..#.....##..######.###
            #....###.#...##.####.#..##.####.#...#.#....#.##...###........#..#..####.#.#.#....##.#.#.#.##..#.#..#
            ##.......#...##.####.###...#...#..##.....#..##..#......#.#..#.##..........#.#..#..#..####..##....#..
            #....####.....#...#.#.#####.#...##.###......#.##...##.##..#.#....##....#.....##..###.......#..##.#.#
            ....#..#...#..##.###.##.##..#.#.##..########..###.##.#..#.#.###.....#..###..###....#..##.#.....#.##.
            #..#.#..#.###..#.####.....#...#...##...#....##..##...###.#.#########..##..##.#.#.#.##.#...#.#..#...#
            ..##.####.#..##...##.#.###.###..##.#.##..##....#.#.###.#.###.###..#.###..##.....##......####.##.....
            .###.###..#....##.#####.##.#.#.####.#.##..#.###..#...#..#.###.####.#.#...##..###.##.#####...##..##.#
            ...####.##.###.#.###...####.....#.#.###..#.##.###..###.#.###..#.##....#.####.#..#.#..###...#..#####.""";
}